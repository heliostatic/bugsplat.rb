if ($http_user_agent ~* NetShelter) {
    return 403;
}

location /mastering-modern-payments {
  if ( $scheme != 'https' ) {
    rewrite ^ <%= ENV['PRIMARY_DOMAIN'] %>$request_uri? permanent;
  }
  try_files $uri/index.html $uri.html $uri @app;
}

location /bits {
  proxy_pass http://bits.petekeen.net;
}

<% pages.each do |page| %>
<% next unless page.page_id %>
rewrite ^/<%= page.page_id %>$ <%= ENV['PRIMARY_DOMAIN'] %><%= page.html_path %> permanent;
<% next unless page.alternate_links.length > 0 %>
<% page.alternate_links.each do |link| %>
rewrite ^/<%= link %>$ <%= ENV['PRIMARY_DOMAIN'] %><%= page.html_path %> permanent;
<% end %>
<% end %>

rewrite ^/payment-integration\.html <%= ENV['PRIMARY_DOMAIN'] %>/mastering-modern-payments permanent;
rewrite ^/mmp(\?.*)? <%= ENV['PRIMARY_DOMAIN'] %>/mastering-modern-payments$1 permanent;
rewrite ^/mmppo <%= ENV['PRIMARY_DOMAIN'] %>/mastering-modern-payments permanent;
rewrite ^/mmp-preorders <%= ENV['PRIMARY_DOMAIN'] %>/mastering-modern-payments permanent;
rewrite ^/cheat <%= ENV['PRIMARY_DOMAIN'] %>/stripe-webhook-event-cheatsheet permanent;
rewrite ^/list <%= ENV['PRIMARY_DOMAIN'] %>/the-big-list-of-stripe-resources permanent;
rewrite ^/events <%= ENV['PRIMARY_DOMAIN'] %>/stripe-webhook-event-cheatsheet permanent;
rewrite ^/\d\d\d\d-\d\d-\d\d-(.*)\.html <%= ENV['PRIMARY_DOMAIN'] %>/$1 permanent;
rewrite ^/\d\d\d\d-\d\d-\d\d-(.*) <%= ENV['PRIMARY_DOMAIN'] %>/$1 permanent;
rewrite ^/(.*)\.html <%= ENV['PRIMARY_DOMAIN'] %>/$1 permanent;

if ( $host != '<%= ENV['PRIMARY_HOST'] %>' ) {
  rewrite ^(.*)$ <%= ENV['PRIMARY_DOMAIN'] %>$request_uri? permanent;
}

expires 5m;
add_header Pragma public;
add_header Cache-Control "public, must-revalidate, proxy-revalidate";
